<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Captura OCR Casero - Placas Guanajuato</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #111; color: #fff; text-align: center; }
    video, canvas { width: 100%; max-width: 480px; border: 2px solid #ccc; border-radius: 10px; }
    #guia {
      position: absolute; top: 50%; left: 50%; width: 250px; height: 80px;
      transform: translate(-50%, -50%); border: 2px dashed red; box-sizing: border-box; pointer-events: none;
    }
    #contenedorCamara { position: relative; display: inline-block; }
    #estadoOCR, #estadoSend { margin: 1rem 0; font-weight: bold; }
    .estado-exito { color: #00c853; }
    .estado-error { color: #ff5722; }
    .estado-warning { color: #ff9800; }
    button {
      padding: 10px 20px; font-size: 1rem; margin: 0.5rem;
      border-radius: 8px; border: none; background-color: #00c853; color: white; cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover:not(:disabled) { background-color: #00a542; }
    button:disabled { opacity: .6; cursor: not-allowed; background-color: #666; }
    input[type="text"] {
      width: 100%; max-width: 320px; padding: .6rem .8rem; margin: 0.5rem;
      border-radius: 8px; border: 1px solid #444; background: #000; color: #fff; text-align: center;
    }
    #tipoVehiculo {
      background: #333; padding: 0.5rem; border-radius: 5px; margin: 0.5rem;
      font-size: 0.9rem; display: inline-block;
    }
    .auto { border-left: 4px solid #2196f3; }
    .camioneta { border-left: 4px solid #ff9800; }
    #preview { max-width: 200px; border: 1px solid #444; border-radius: 5px; margin: 1rem; }
    #estadisticas {
      background: #222; padding: 1rem; border-radius: 8px; margin: 1rem 0;
      font-size: 0.9rem; text-align: left; max-width: 400px; margin: 1rem auto;
    }
  </style>
</head>
<body>

  <h2>🚗 OCR Casero - Placas Guanajuato</h2>
  <p style="font-size: 0.9rem; color: #888;">Detecta autos (ABC-123-D) y camionetas (AB-1234-C)</p>

  <div id="contenedorCamara">
    <video id="video" autoplay muted playsinline></video>
    <div id="guia"></div>
  </div>

  <div>
    <button id="btnCapturar" disabled>📸 Capturar y Analizar</button>
    <button id="btnContinuo" disabled>🔄 Modo Continuo</button>
  </div>

  <p id="estadoOCR">Cargando cámara…</p>
  
  <div id="tipoVehiculo" style="display: none;"></div>
  
  <input type="text" id="resultadoPlaca" placeholder="Placa detectada aparecerá aquí..." />

  <div>
    <button id="btnConfirmar" disabled>✅ Confirmar y Enviar</button>
    <button id="btnReintentar" disabled>🔄 Reintentar OCR</button>
  </div>
  
  <p id="estadoSend">Esperando confirmación…</p>

  <canvas id="canvas" style="display:none;"></canvas>
  <canvas id="previewCanvas" style="display:none;"></canvas>
  
  <img id="preview" style="display:none;" alt="Vista previa de la captura">

  <div id="estadisticas">
    <h4>📊 Estadísticas de Sesión</h4>
    <div>Capturas totales: <span id="statCapturas">0</span></div>
    <div>Placas detectadas: <span id="statDetectadas">0</span></div>
    <div>Autos: <span id="statAutos">0</span></div>
    <div>Camionetas: <span id="statCamionetas">0</span></div>
    <div>Tasa éxito: <span id="statTasa">0%</span></div>
  </div>

  <script>
    // Variables globales
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const previewCanvas = document.getElementById('previewCanvas');
    const preview = document.getElementById('preview');
    const estadoOCR = document.getElementById('estadoOCR');
    const estadoSend = document.getElementById('estadoSend');
    const inputPlaca = document.getElementById('resultadoPlaca');
    const tipoVehiculo = document.getElementById('tipoVehiculo');
    const btnCapturar = document.getElementById('btnCapturar');
    const btnContinuo = document.getElementById('btnContinuo');
    const btnConfirmar = document.getElementById('btnConfirmar');
    const btnReintentar = document.getElementById('btnReintentar');
    const ctx = canvas.getContext('2d');
    const previewCtx = previewCanvas.getContext('2d');

    // Estadísticas
    let stats = {
      capturas: 0,
      detectadas: 0,
      autos: 0,
      camionetas: 0
    };

    // Estado del sistema
    let imagenOCRCapturada = "";
    let modocontinuo = false;
    let procesando = false;
    let enviando = false;
    let _ultima = { placa: '', t: 0 };

    // ==== Inicialización de cámara ====
    async function iniciarCamara() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment', width: 1280, height: 720 }, 
          audio: false 
        });
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => {
          if (video.videoWidth && video.videoHeight) {
            btnCapturar.disabled = false;
            btnContinuo.disabled = false;
            estadoOCR.textContent = 'Cámara activa. Enfoca la placa y presiona Capturar.';
            estadoOCR.className = '';
          }
        });
      } catch (err) {
        console.error('Error al acceder a la cámara:', err);
        estadoOCR.textContent = 'Error al acceder a la cámara ❌';
        estadoOCR.className = 'estado-error';
      }
    }

    // ==== Utilidades ====
    const normalizar = s => String(s || '').toUpperCase().replace(/[^A-Z0-9]/g, '');

    function actualizarEstadisticas() {
      document.getElementById('statCapturas').textContent = stats.capturas;
      document.getElementById('statDetectadas').textContent = stats.detectadas;
      document.getElementById('statAutos').textContent = stats.autos;
      document.getElementById('statCamionetas').textContent = stats.camionetas;
      const tasa = stats.capturas > 0 ? Math.round((stats.detectadas / stats.capturas) * 100) : 0;
      document.getElementById('statTasa').textContent = tasa + '%';
    }

    function mostrarTipoVehiculo(tipo) {
      if (tipo === 'AUTO' || tipo === 'CAMIONETA') {
        tipoVehiculo.textContent = `🚗 Vehículo: ${tipo}`;
        tipoVehiculo.className = tipo.toLowerCase();
        tipoVehiculo.style.display = 'inline-block';
      } else {
        tipoVehiculo.style.display = 'none';
      }
    }

    // ==== Validación de placas Guanajuato ====
    function validarPlacaGuanajuato(text) {
      const cleaned = normalizar(text);
      
      // Formato AUTOS: 3 letras + 3 números + 1 letra (7 caracteres)
      if (cleaned.length === 7 && /^[A-Z]{3}[0-9]{3}[A-Z]$/.test(cleaned)) {
        return {
          placa: `${cleaned.slice(0,3)}-${cleaned.slice(3,6)}-${cleaned.slice(6)}`,
          tipo: 'AUTO',
          confianza: 'ALTA',
          valida: true
        };
      }
      
      // Formato CAMIONETAS: 2 letras + 4 números + 1 letra (7 caracteres)  
      if (cleaned.length === 7 && /^[A-Z]{2}[0-9]{4}[A-Z]$/.test(cleaned)) {
        return {
          placa: `${cleaned.slice(0,2)}-${cleaned.slice(2,6)}-${cleaned.slice(6)}`,
          tipo: 'CAMIONETA',
          confianza: 'ALTA',
          valida: true
        };
      }

      // Formatos sin letra final (6 caracteres)
      if (cleaned.length === 6) {
        if (/^[A-Z]{3}[0-9]{3}$/.test(cleaned)) {
          return {
            placa: `${cleaned.slice(0,3)}-${cleaned.slice(3)}`,
            tipo: 'AUTO',
            confianza: 'MEDIA',
            valida: true
          };
        }
        if (/^[A-Z]{2}[0-9]{4}$/.test(cleaned)) {
          return {
            placa: `${cleaned.slice(0,2)}-${cleaned.slice(2)}`,
            tipo: 'CAMIONETA', 
            confianza: 'MEDIA',
            valida: true
          };
        }
      }

      return { valida: false };
    }

    // ==== OCR Local (simulado - aquí conectarías tu backend) ====
    async function procesarOCRLocal(imageBlob) {
      // Aquí deberías llamar a tu backend que tiene EasyOCR
      // Por ahora simulo la respuesta para que veas la estructura
      
      try {
        const formData = new FormData();
        formData.append('image', imageBlob, 'captura.jpg');
        
        // Llamada a tu endpoint de OCR local
        const response = await fetch('/api/ocr-local', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('Error en el servidor OCR');
        }

        const data = await response.json();
        return data;

      } catch (error) {
        console.error('Error OCR local:', error);
        
        // DEMO: Simulación para que puedas probar la interfaz
        // En producción, elimina esto y maneja el error real
        return simularRespuestaOCR();
      }
    }

    // Función demo - eliminar en producción
    function simularRespuestaOCR() {
      const ejemplos = [
        { text: 'GUH659B', confidence: 0.92 },
        { text: 'AB1234C', confidence: 0.87 },
        { text: 'XYZ890D', confidence: 0.76 },
        { text: '', confidence: 0 } // Sin detección
      ];
      
      const random = ejemplos[Math.floor(Math.random() * ejemplos.length)];
      return {
        success: random.confidence > 0,
        text: random.text,
        confidence: random.confidence,
        processed_time: Math.random() * 2 + 0.5 // 0.5-2.5 segundos
      };
    }

    // ==== Captura y procesamiento ====
    async function capturarYProcesar() {
      if (procesando) return;
      
      procesando = true;
      stats.capturas++;
      
      // Capturar imagen
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 360;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Crear vista previa más pequeña
      previewCanvas.width = 200;
      previewCanvas.height = (canvas.height * 200) / canvas.width;
      previewCtx.drawImage(canvas, 0, 0, previewCanvas.width, previewCanvas.height);
      
      // Mostrar vista previa
      preview.src = previewCanvas.toDataURL('image/jpeg', 0.8);
      preview.style.display = 'block';
      
      estadoOCR.textContent = 'Procesando con OCR local...';
      estadoOCR.className = '';
      
      canvas.toBlob(async (blob) => {
        try {
          // Guardar la imagen capturada
          const fr = new FileReader();
          fr.onload = () => { imagenOCRCapturada = fr.result; };
          fr.readAsDataURL(blob);
          
          // Procesar con OCR local
          const startTime = Date.now();
          const ocrResult = await procesarOCRLocal(blob);
          const processingTime = ((Date.now() - startTime) / 1000).toFixed(1);
          
          if (ocrResult.success && ocrResult.text) {
            const validacion = validarPlacaGuanajuato(ocrResult.text);
            
            if (validacion.valida) {
              stats.detectadas++;
              if (validacion.tipo === 'AUTO') stats.autos++;
              else if (validacion.tipo === 'CAMIONETA') stats.camionetas++;
              
              inputPlaca.value = validacion.placa;
              mostrarTipoVehiculo(validacion.tipo);
              btnConfirmar.disabled = false;
              btnReintentar.disabled = false;
              
              if (ocrResult.confidence > 0.85) {
                estadoOCR.textContent = `✅ ${validacion.placa} (${validacion.tipo}) - ${processingTime}s`;
                estadoOCR.className = 'estado-exito';
              } else {
                estadoOCR.textContent = `⚠️ ${validacion.placa} (${validacion.tipo}) - Verificar - ${processingTime}s`;
                estadoOCR.className = 'estado-warning';
              }
            } else {
              estadoOCR.textContent = `❌ Texto detectado pero no es placa válida: "${ocrResult.text}" - ${processingTime}s`;
              estadoOCR.className = 'estado-error';
              btnReintentar.disabled = false;
            }
          } else {
            estadoOCR.textContent = `❌ No se detectó texto en la imagen - ${processingTime}s`;
            estadoOCR.className = 'estado-error';
            btnReintentar.disabled = false;
          }
          
        } catch (error) {
          console.error('Error procesando OCR:', error);
          estadoOCR.textContent = '❌ Error al procesar imagen';
          estadoOCR.className = 'estado-error';
          btnReintentar.disabled = false;
        } finally {
          procesando = false;
          actualizarEstadisticas();
          
          // Continuar en modo continuo si está activo
          if (modoontinuo && !procesando) {
            setTimeout(() => {
              if (modoontinuo) capturarYProcesar();
            }, 2000);
          }
        }
      }, 'image/jpeg', 0.9);
    }

    // ==== Event Listeners ====
    btnCapturar.addEventListener('click', capturarYProcesar);
    
    btnContinuo.addEventListener('click', () => {
      modoontinuo = !modoontinuo;
      if (modoontinuo) {
        btnContinuo.textContent = '⏸️ Parar Continuo';
        btnContinuo.style.backgroundColor = '#ff5722';
        if (!procesando) capturarYProcesar();
      } else {
        btnContinuo.textContent = '🔄 Modo Continuo';
        btnContinuo.style.backgroundColor = '#00c853';
      }
    });
    
    btnReintentar.addEventListener('click', () => {
      btnReintentar.disabled = true;
      btnConfirmar.disabled = true;
      inputPlaca.value = '';
      mostrarTipoVehiculo('');
      capturarYProcesar();
    });

    // Verificar si placa existe en pendientes
    async function existePendiente(placa) {
      try {
        const r = await fetch('/api/pendientes', { cache: 'no-store' });
        const data = await r.json();
        if (!r.ok) return false;
        const lista = Array.isArray(data.data) ? data.data : [];
        return lista.some(x => String(x.placa || '').toUpperCase() === placa);
      } catch { 
        return false; 
      }
    }

    // Confirmar y enviar
    btnConfirmar.addEventListener('click', async () => {
      const placa = normalizar(inputPlaca.value);
      if (!placa || placa.length < 5) {
        estadoSend.textContent = 'Placa inválida. Corrige antes de enviar.';
        estadoSend.className = 'estado-error';
        return;
      }

      // Anti-duplicados
      const ahora = Date.now();
      if (_ultima.placa === placa && (ahora - _ultima.t) < 5000) {
        estadoSend.textContent = `Ya enviaste ${placa} hace poco.`;
        estadoSend.className = 'estado-warning';
        return;
      }

      if (await existePendiente(placa)) {
        estadoSend.textContent = `Omitido: ${placa} ya está en pendientes.`;
        estadoSend.className = 'estado-warning';
        inputPlaca.value = '';
        btnConfirmar.disabled = true;
        return;
      }

      if (enviando) return;
      
      enviando = true;
      btnConfirmar.disabled = true;

      try {
        estadoSend.textContent = 'Enviando...';
        estadoSend.className = '';
        
        const imagen = imagenOCRCapturada || '';

        const r = await fetch('/api/pendientes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ placa, imagen })
        });
        
        const data = await r.json();
        if (!r.ok) throw new Error(data?.msg || 'Error al enviar');

        try { 
          localStorage.setItem('placaDetectadaOCR', placa); 
        } catch {}
        
        _ultima = { placa, t: ahora };
        inputPlaca.value = '';
        mostrarTipoVehiculo('');
        preview.style.display = 'none';
        
        estadoSend.textContent = `Enviado ✓ (${placa}). Listo para siguiente captura.`;
        estadoSend.className = 'estado-exito';
        
      } catch (e) {
        console.error(e);
        estadoSend.textContent = 'No se pudo enviar: ' + e.message;
        estadoSend.className = 'estado-error';
      } finally {
        enviando = false;
        setTimeout(() => {
          btnConfirmar.disabled = false;
        }, 2000);
      }
    });

    // Normalizar input
    inputPlaca.addEventListener('input', e => {
      e.target.value = normalizar(e.target.value);
    });

    // Inicializar
    iniciarCamara();
    actualizarEstadisticas();
  </script>
</body>
</html>